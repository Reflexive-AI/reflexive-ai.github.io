---
import Base from './Base.astro';
import LanguageSwitcher from '../components/LanguageSwitcher.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

interface Props {
  article: CollectionEntry<'research'>;
  headings?: { depth: number; slug: string; text: string }[];
}

const { article, headings = [] } = Astro.props;
const { title, excerpt, date, categories, tags, keywords, lastModified } = article.data;

// Generate TOC from headings (h2 and h3 only)
const tocHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);

// Calculate reading time
const wordCount = article.body?.split(/\s+/).length || 0;
const readingTime = Math.ceil(wordCount / 200);

// Determine current language and base slug
const slug = article.slug;
let currentLang: 'en' | 'es' | 'ca' = 'en';
let baseSlug = slug;
if (slug.startsWith('es/')) {
  currentLang = 'es';
  baseSlug = slug.slice(3);
} else if (slug.startsWith('ca/')) {
  currentLang = 'ca';
  baseSlug = slug.slice(3);
}

// Check which translations exist
const allArticles = await getCollection('research');
const allSlugs = new Set(allArticles.map(a => a.slug));
const availableTranslations = {
  en: allSlugs.has(baseSlug),
  es: allSlugs.has(`es/${baseSlug}`),
  ca: allSlugs.has(`ca/${baseSlug}`),
};

// Language metadata
const langCode = currentLang === 'en' ? 'en' : currentLang === 'es' ? 'es' : 'ca';
const dateLocale = currentLang === 'es' ? 'es-ES' : currentLang === 'ca' ? 'ca-ES' : 'en-US';

// Build canonical URL
const canonicalUrl = `https://reflexive-ai.github.io/research/${article.slug}/`;

// Combine tags and keywords for meta
const allKeywords = [...new Set([...(keywords || []), ...(tags || [])])];
---

<Base 
  title={title} 
  description={excerpt}
  canonicalUrl={canonicalUrl}
  publishedDate={date}
  modifiedDate={lastModified || date}
  keywords={allKeywords}
  type="article"
>
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "ScholarlyArticle",
    "headline": title,
    "description": excerpt,
    "datePublished": date.toISOString(),
    "dateModified": (lastModified || date).toISOString(),
    "author": {
      "@type": "Organization",
      "name": "Reflexive AI Initiative",
      "url": "https://reflexive-ai.github.io"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Reflexive AI Initiative",
      "url": "https://reflexive-ai.github.io",
      "logo": {
        "@type": "ImageObject",
        "url": "https://reflexive-ai.github.io/logo.png"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": canonicalUrl
    },
    "keywords": allKeywords.join(", "),
    "wordCount": wordCount,
    "articleSection": categories[0] || "Research",
    "inLanguage": langCode
  })} />

  <div class="article-layout">
    <article class="article" itemscope itemtype="https://schema.org/ScholarlyArticle">
      <header class="article__header">
        <div class="article__meta">
          {categories.map((cat: string) => (
            <a href={`/research`} class="article__category" itemprop="articleSection">{cat}</a>
          ))}
          <span>·</span>
          <time datetime={date.toISOString()} itemprop="datePublished">
            {date.toLocaleDateString(dateLocale, { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
          <span>·</span>
          <span class="article__reading-time">{readingTime} min read</span>
        </div>

        <LanguageSwitcher
          currentLang={currentLang}
          baseSlug={baseSlug}
          availableTranslations={availableTranslations}
        />

        <h1 class="article__title" itemprop="headline">{title}</h1>
        <p class="article__excerpt" itemprop="description">{excerpt}</p>
      </header>
      
      {/* Mobile TOC - collapsible */}
      {tocHeadings.length > 0 && (
        <div class="toc-mobile">
          <button 
            class="toc-mobile__button" 
            aria-expanded="false"
            onclick="this.setAttribute('aria-expanded', this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true'); this.nextElementSibling.classList.toggle('open');"
          >
            <span>On This Page</span>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <nav class="toc-mobile__content">
            <ul class="toc-mobile__list">
              {tocHeadings.map(heading => (
                <li style={`margin-left: ${(heading.depth - 2) * 12}px`}>
                  <a href={`#${heading.slug}`}>{heading.text}</a>
                </li>
              ))}
            </ul>
          </nav>
        </div>
      )}
      
      <div class="article__content" itemprop="articleBody">
        <slot />
      </div>
      
      {tags.length > 0 && (
        <footer class="article__footer" style="margin-top: var(--space-12); padding-top: var(--space-6); border-top: 1px solid var(--color-border);">
          <div class="article-card__meta">
            {tags.map((tag: string) => (
              <a href={`/tags`} class="article-card__tag" itemprop="keywords">{tag}</a>
            ))}
          </div>
        </footer>
      )}
    </article>
    
    {/* Desktop Sidebar TOC */}
    {tocHeadings.length > 0 && (
      <aside class="toc-sidebar" id="toc-sidebar">
        <div class="toc-sidebar__inner">
          <div class="toc-sidebar__header">
            <span class="toc-sidebar__title">On This Page</span>
            <button 
              class="toc-sidebar__toggle" 
              aria-label="Toggle table of contents"
              onclick="document.getElementById('toc-sidebar').classList.toggle('collapsed');"
            >
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <ul class="toc-sidebar__list">
            {tocHeadings.map(heading => (
              <li style={`margin-left: ${(heading.depth - 2) * 12}px`}>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    )}
  </div>
  
  {/* Scroll progress indicator */}
  <div class="scroll-progress" id="scroll-progress"></div>
  
  <script>
    // Scroll progress
    const progressBar = document.getElementById('scroll-progress');
    if (progressBar) {
      window.addEventListener('scroll', () => {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = (scrollTop / docHeight) * 100;
        progressBar.style.width = `${progress}%`;
      });
    }
    
    // Active TOC link highlighting
    const tocLinks = document.querySelectorAll('.toc-sidebar__list a');
    const headings = document.querySelectorAll('.article__content h2, .article__content h3');
    
    if (tocLinks.length > 0 && headings.length > 0) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            tocLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.toc-sidebar__list a[href="#${entry.target.id}"]`);
            if (activeLink) activeLink.classList.add('active');
          }
        });
      }, { rootMargin: '-20% 0% -60% 0%' });
      
      headings.forEach(heading => observer.observe(heading));
    }
  </script>
</Base>
