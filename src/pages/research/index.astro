---
import Base from '@/layouts/Base.astro';
import ArticleCard from '@/components/ArticleCard.astro';
import { getCollection } from 'astro:content';

const allArticles = (await getCollection('research')).filter(a => !a.slug.startsWith('es/') && !a.slug.startsWith('ca/'));
const sortedArticles = allArticles
  .filter(a => !a.data.draft)
  .sort((a, b) => {
    // Sort by article number extracted from slug (e.g., "051-foo")
    const numA = parseInt(a.slug.split('-')[0], 10) || 0;
    const numB = parseInt(b.slug.split('-')[0], 10) || 0;
    return numB - numA; // Descending: newest first
  });

const siteUrl = 'https://reflexive-ai.github.io';

const collectionJsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "AI Governance Research Articles",
  "description": `${sortedArticles.length} research articles exploring AI governance, safety, regulation, and the role of AI systems in their own oversight.`,
  "url": `${siteUrl}/research/`,
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": sortedArticles.length,
    "itemListElement": sortedArticles.slice(0, 20).map((article, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `${siteUrl}/research/${article.slug}/`,
      "name": article.data.title
    }))
  }
};
---

<Base 
  title="Research" 
  description={`Browse ${sortedArticles.length} research articles on AI governance, safety, reflexive AI, and regulation. From EU AI Act analysis to machine-readable constraint schemas.`}
  keywords={['AI governance articles', 'AI safety research', 'AI regulation papers', 'reflexive AI research', 'AI policy analysis']}
  breadcrumbs={[
    { name: 'Home', url: siteUrl },
    { name: 'Research', url: `${siteUrl}/research/` },
  ]}
  jsonLd={[collectionJsonLd]}
>
  <div class="container" style="padding: var(--space-12) var(--space-6);">
    <header style="margin-bottom: var(--space-10);">
      <h1>Research</h1>
      <p class="text-secondary" style="font-size: 1.2rem; max-width: 60ch;">
        {sortedArticles.length} articles exploring AI governance, safety, and the role of 
        AI systems in their own regulation.
      </p>
    </header>
    
    <div class="article-grid">
      {sortedArticles.map((article) => {
        const num = parseInt(article.slug.split('-')[0], 10);
        return (
          <ArticleCard
            number={num}
            title={article.data.title}
            excerpt={article.data.excerpt}
            slug={article.slug}
            tags={article.data.tags}
          />
        );
      })}
    </div>
  </div>
</Base>
