name: Generate Daily Article

on:
  schedule:
    # Runs at 6:00 AM UTC every day
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      article_count:
        description: 'Number of articles to generate'
        required: false
        default: '1'
        type: string
      model:
        description: 'AI model to use'
        required: false
        default: 'gpt-4o'
        type: choice
        options:
          - gpt-4o
          - gpt-4o-mini
          - claude-3-5-sonnet

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Generate article with GitHub Models
        uses: actions/github-script@v7
        id: generate
        env:
          ARTICLE_COUNT: ${{ github.event.inputs.article_count || '1' }}
          MODEL: ${{ github.event.inputs.model || 'gpt-4o' }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read the article list to find next unpublished article
            const articleListPath = 'ARTICLE_LIST_100.md';
            const articleList = fs.readFileSync(articleListPath, 'utf8');
            
            // Find existing articles
            const researchDir = 'src/content/research';
            const existingFiles = fs.existsSync(researchDir) ? fs.readdirSync(researchDir) : [];
            const existingNumbers = new Set(
              existingFiles
                .filter(f => f.endsWith('.md'))
                .map(f => parseInt(f.split('-')[0]))
                .filter(n => !isNaN(n))
            );
            
            // Parse article list for unpublished articles
            const unpublishedPattern = /^(\d+)\.\s*\[\s*\]\s*(.+?)(?:\s*\[([A-Z\]\[]+)\])?\s*$/gm;
            const unpublished = [];
            let match;
            while ((match = unpublishedPattern.exec(articleList)) !== null) {
              const num = parseInt(match[1]);
              if (!existingNumbers.has(num)) {
                unpublished.push({
                  number: num,
                  title: match[2].trim(),
                  tags: match[3] || ''
                });
              }
            }
            
            if (unpublished.length === 0) {
              console.log('No unpublished articles found');
              return;
            }
            
            const count = parseInt(process.env.ARTICLE_COUNT) || 1;
            const toGenerate = unpublished.slice(0, count);
            
            console.log(`Generating ${toGenerate.length} article(s):`);
            toGenerate.forEach(a => console.log(`  ${a.number}. ${a.title}`));
            
            // Get a sample article for style reference
            let sampleContent = '';
            if (existingFiles.length > 0) {
              const sampleFile = existingFiles.find(f => f.endsWith('.md'));
              if (sampleFile) {
                sampleContent = fs.readFileSync(path.join(researchDir, sampleFile), 'utf8').slice(0, 3000);
              }
            }
            
            // Generate each article using GitHub Models API
            const generatedFiles = [];
            
            for (const article of toGenerate) {
              const prompt = `You are a research writer for the Reflexive AI Initiative, a think tank focused on AI governance, safety, and the role of AI in its own regulation.

            Write a complete research article with this title: "${article.title}"
            Article number: ${article.number}
            Tags hint: ${article.tags} (R=Research, P=Policy, A=AI-focused)

            Requirements:
            1. Start with YAML frontmatter (title, excerpt, date: ${new Date().toISOString().split('T')[0]}, toc: true, categories, tags)
            2. Write 1500-2500 words of substantive, evidence-based content
            3. Include 4-6 major sections with ## headers
            4. Use an academic but accessible tone
            5. Cross-reference related concepts where relevant
            6. End with a conclusion section
            7. Add an italicized note about scope/limitations at the end

            ${sampleContent ? `Here's an example of our style:\n\n${sampleContent}` : ''}

            Write the complete article now:`;
              
              // Use GitHub Models API via fetch (available to GitHub Pro users)
              const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`
                },
                body: JSON.stringify({
                  model: process.env.MODEL,
                  messages: [{ role: 'user', content: prompt }],
                  max_tokens: 4096,
                  temperature: 0.7
                })
              });
              
              if (!response.ok) {
                console.error(`API error: ${response.status} ${response.statusText}`);
                const errorText = await response.text();
                console.error(errorText);
                continue;
              }
              
              const data = await response.json();
              const content = data.choices[0].message.content;
              
              // Generate filename
              const slug = article.title.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .slice(0, 50)
                .replace(/-+$/, '');
              
              const filename = `${String(article.number).padStart(3, '0')}-${slug}.md`;
              const filepath = path.join(researchDir, filename);
              
              // Ensure directory exists
              if (!fs.existsSync(researchDir)) {
                fs.mkdirSync(researchDir, { recursive: true });
              }
              
              fs.writeFileSync(filepath, content);
              console.log(`✓ Generated: ${filename}`);
              generatedFiles.push(filename);
              
              // Only mark article as complete AFTER file is successfully written
              let currentList = fs.readFileSync(articleListPath, 'utf8');
              const pattern = new RegExp(`^(${article.number})\\.\\s*\\[\\s*\\]`, 'm');
              currentList = currentList.replace(pattern, `$1. [x]`);
              fs.writeFileSync(articleListPath, currentList);
              console.log(`✓ Marked article ${article.number} as complete`);
            }
            
            return generatedFiles.join(',');
            
      - name: Commit and push
        if: steps.generate.outputs.result != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "Add generated article(s) - $(date +'%Y-%m-%d')"
          git push
